import e,{useContext as t}from"react";import s from"@vista.io/vista-api-client";export{default as VistaClient}from"@vista.io/vista-api-client";import{withStyles as r}from"@mui/styles";import l from"@mui/material/Button";import a from"@mui/material/FormControl";import o from"@mui/material/InputLabel";import n from"@mui/material/Checkbox";import i from"@mui/material/Box";import c from"@mui/material/List";import p from"@mui/material/ListItem";import m from"@mui/material/ListItemText";import d from"@mui/material/MenuItem";import h from"@mui/material/Select";import u from"@mui/material/Chip";import g from"@mui/material/Autocomplete";import y from"@mui/material/TextField";import b from"@mui/material/ListItemButton";import f from"react-data-table-component";const S=e.createContext({secret:"",defaultClient:new s("","","")});class x extends e.Component{render(){const{secret:t,branch:r,hostname:l}=this.props,a=new s(t,r,l);return e.createElement(S.Provider,{value:{secret:this.props.secret,defaultClient:a}},this.props.children)}}class I extends e.Component{constructor(){super(...arguments),this.state={hasChecked:!1,granted:!1},this.componentDidMount=async()=>{if(!this.state.hasChecked){const e=this.context.defaultClient,t=(await e.users.check(this.props.userId,this.props.action,this.props.resourceId,this.props.resourceType,this.props.branch).catch((e=>{this.props.handleError?this.props.handleError(e):console.log(e)}))).length>0;t&&this.setState({hasChecked:!0,granted:t})}}}renderedComponent(){return this.state.hasChecked&&this.state.granted?this.props.children:this.props.denyComponent?this.props.denyComponent:null}render(){return e.createElement(e.Fragment,null,this.renderedComponent())}}I.contextType=S;function R(t){const{label:s,userRoles:r,grantSelectLabel:l,grantSelectLabelStyles:c,allRoles:p,selectClassName:g,chipsClassName:y,selectStyles:b,chipsStyles:f,grantRole:S,revokeRole:x}=t;return e.createElement(a,{sx:{minWidth:"200px"}},e.createElement(o,{className:l,style:c,shrink:r.length>0},s||""),e.createElement(h,{multiple:!0,value:[...r],renderValue:t=>e.createElement(i,{sx:{display:"flex",flexWrap:"wrap",gap:.5}},t.sort().map((t=>e.createElement(u,{key:t,label:t,className:y,style:f||{}})))),onChange:e=>{const t=e.target.value;if(t.length<r.length){const e=new Set(t),s=r.find((t=>!e.has(t)));s&&x(s)}else{const e=new Set(r),s=t.find((t=>!e.has(t)));s&&S(s)}},label:s||"",className:g,style:b||{}},p.map((e=>e.id)).sort().map((t=>e.createElement(d,{key:t,value:t},e.createElement(n,{checked:r.includes(t)}),e.createElement(m,{primary:t}))))))}class w extends e.Component{constructor(e,t){super(e),this.onGrantChange=async(e,t,s)=>{const{branch:r,orgId:l,onGrant:a}=this.props;if(!a)return;const o=await s(e,t,l,r);return o&&await this.refresh(l,r),o},this.state={client:t.defaultClient,userIdInput:"",selectedUserId:"",selectedRoleIds:[],roles:[],usersetIdToGrants:{},userIds:[],orgId:e.orgId,branch:e.branch}}async componentDidUpdate(){const{orgId:e,branch:t}=this.props;this.state.orgId===e&&this.state.branch===t||""!==e&&""!==t&&(await this.refresh(this.props.orgId,this.props.branch),this.setState({orgId:this.props.orgId,branch:this.props.branch}))}async refresh(e,t){const s=(await this.state.client.withBranch(t).users.list(e)).map((e=>e.id)),r=await this.state.client.withBranch(t).roles.list(e),l=await this.state.client.withBranch(t).grants.listUnflattened(null,null,null,null,null,null,e),a={};l.forEach((e=>{a[e.userset_id]||(a[e.userset_id]=[]),"ROLE"===e.relation_type&&a[e.userset_id].push(e)})),this.setState({userIds:s,roles:r,usersetIdToGrants:a})}render(){const{classes:t,styles:s,userIdMap:r,title:a,onGrant:o,onRevoke:n}=this.props,{selectedUserId:i,selectedRoleIds:d,roles:h,usersetIdToGrants:u,userIds:b,userIdInput:f}=this.state;return e.createElement("div",{className:t.container,style:s.container},e.createElement("h1",{className:t.title,style:s.title},a),e.createElement("div",{className:t.newGrantRow,style:s.newGrantRow},e.createElement("div",{className:t.userSelectContainer,style:s.userSelectContainer},e.createElement(g,{value:i,onChange:(e,t)=>{this.setState({selectedUserId:t||"",selectedRoleIds:[]})},inputValue:f,onInputChange:(e,t)=>{this.setState({userIdInput:t})},className:t.userSelect,style:s.userSelect,sx:{width:"100% "},options:r?["*",...Object.keys(r)]:["*",...b],renderInput:r=>e.createElement(y,Object.assign({},r,{InputLabelProps:{className:t.grantSelectLabel,style:s.grantSelectLabel},label:"Select User"}))})),e.createElement("div",{className:t.roleSelect,style:s.roleSelect},e.createElement(R,{label:"Select Role",userRoles:d,grantRole:e=>{d.push(e),this.setState({selectedRoleIds:d})},revokeRole:e=>{this.setState({selectedRoleIds:d.filter((t=>t!==e))})},selectClassName:t.grantRoleSelect,chipsClassName:t.grantRoleSelectChip,selectStyles:s.grantRoleSelect,chipsStyles:s.grantRoleSelectChip,grantSelectLabel:t.grantSelectLabel,grantSelectLabelStyles:s.grantSelectLabel,allRoles:i.length&&u[i]?h.filter((e=>!u[i].map((e=>e.relation)).includes(e.id))):h})),e.createElement(l,{className:t.grantButton,style:s.grantButton,variant:"contained",disabled:!(i.length&&d.length),onClick:async()=>{for(const e of d)await this.onGrantChange(i,e,o);this.setState({selectedUserId:"",selectedRoleIds:[]})}},"Grant")),e.createElement("div",{className:t.grantList,style:s.grantList},e.createElement(c,null,Object.keys(u).sort().map((r=>{const l=u[r],a=l.map((e=>e.relation));return e.createElement(p,{key:r,className:t.grantRow,style:s.grantRow,secondaryAction:e.createElement(R,{userRoles:a,grantRole:e=>{l.push({userId:r,relation:e,userset_id:r,relation_type:"ROLE"}),u[r]=l,this.onGrantChange(r,e,o),this.setState({usersetIdToGrants:u})},revokeRole:e=>{const t=l.filter((t=>t.relation!==e));u[r]=t,this.onGrantChange(r,e,n),this.setState({usersetIdToGrants:u})},selectClassName:t.grantRoleSelect,chipsClassName:t.grantRoleSelectChip,selectStyles:s.grantRoleSelect,chipsStyles:s.grantRoleSelectChip,grantSelectLabel:t.grantSelectLabel,grantSelectLabelStyles:s.grantSelectLabel,allRoles:h})},e.createElement(m,{primary:r}))})))))}}w.contextType=S,w.defaultProps={styles:{},title:"Add Teammates"};const C=r({container:{height:"500px",width:"600px",display:"flex",flexDirection:"column",border:"solid",borderColor:"lightgray",borderWidth:"1px",padding:"50px",marginBottom:"50px"},title:{marginTop:"0px"},newGrantRow:{display:"flex",marginBottom:"20px"},userSelectContainer:{flexGrow:"1",height:"64px !important",marginRight:"10px"},userSelect:{height:"64px !important","& \t.MuiAutocomplete-inputRoot":{height:"64px"}},grantSelectLabel:{top:"4px"},roleSelect:{marginRight:"10px"},grantButton:{},grantRow:{height:"75px"},grantList:{flexGrow:"1",width:"100%",padding:"0",border:"solid",borderColor:"lightgray",borderWidth:"1px",overflow:"scroll",margin:"0"},grantRoleSelect:{height:"64px"},grantRoleSelectChip:{backgroundColor:"black !important",color:"white !important"}})(w);function E(t){const{row:s,classes:r,text:l}=t,a=t.styles||r;return e.createElement("p",{className:s.inheritedFrom?r.permissionsTableRowInherited:r.permissionsTableRow,style:s.inheritedFrom?a.permissionsTableRowInherited:a.permissionsTableRow}," ",l," ")}function _(t){const{classes:s,styles:r,title:l}=t;return e.createElement("div",{className:s.permissionsTable},e.createElement(f,{title:l,columns:[{name:"Resource Type",selector:()=>"resourceType",sortable:!0,cell:t=>e.createElement(E,{text:t.resourceType,classes:s,styles:r,row:t})},{name:"Attribute",selector:()=>"attribute",sortable:!0,right:!0,cell:t=>e.createElement(E,{text:t.attribute,classes:s,styles:r,row:t})},{name:"Actions",selector:()=>"actions",sortable:!0,right:!0,cell:t=>e.createElement(E,{text:t.actions.join(", "),classes:s,styles:r,row:t})},{name:"Inherited From",selector:()=>"inheritedFrom",sortable:!0,right:!0,cell:t=>e.createElement(E,{text:t.inheritedFrom,classes:s,styles:r,row:t})}],data:(()=>{const{rolesById:e,role:s}=t;if(!s)return[];const r={},l=[...s.parent_roles],a=new Set,o=[];for(;l.length;){const t=l.shift();if(!t||a.has(t))continue;a.add(t);const s=e[t];for(const e in s.resource_types_to_attributes_to_actions)for(const t in s.resource_types_to_attributes_to_actions[e]){const l=s.resource_types_to_attributes_to_actions[e][t],a=`${e}_${t}`;r[a]||(o.push({actions:l,attribute:t,id:a,resourceType:e,inheritedFrom:s.id}),r[a]=!0)}l.push(...s.parent_roles)}for(const e in s.resource_types_to_attributes_to_actions)for(const t in s.resource_types_to_attributes_to_actions[e]){const l=`${e}_${t}`,a=s.resource_types_to_attributes_to_actions[e][t];r[l]||(o.push({id:l,actions:a,attribute:t,resourceType:e,inheritedFrom:""}),r[l]=!0)}return o})()}))}class L extends e.Component{constructor(e,t){super(e),this.state={client:t.defaultClient,rolesById:{},selectedRoleId:""}}async componentDidMount(){const e=await this.state.client.roles.list(this.props.orgId),t={};e.forEach((e=>{t[e.id]=e}));const s=e.length?e[0].id:"";this.setState({rolesById:t,selectedRoleId:s})}render(){const{classes:t}=this.props,s=this.props.styles||t,{rolesById:r,selectedRoleId:l}=this.state;return e.createElement("div",{className:t.container,style:s.container},e.createElement(c,{className:t.rolesList,style:s.rolesList,disablePadding:!0},Object.values(r).map((r=>e.createElement(p,{key:r.id,disablePadding:!0},e.createElement(b,{className:t.rolesListRow,style:s.rolesListRow,selected:l===r.id,disableRipple:!0,onClick:()=>this.setState({selectedRoleId:r.id})},e.createElement(m,{primary:r.id})))))),e.createElement(_,{title:`${l} Permissions`,rolesById:r,role:r[l],classes:t,styles:s}))}}L.contextType=S,L.defaultProps={styles:{}};const T=r({container:{height:"500px",width:"1000px",display:"flex",border:"solid",borderColor:"lightgray",borderWidth:"1px"},title:{marginTop:"0px"},rolesList:{height:"100%",width:"200px",overflow:"scroll",borderRight:"1px solid lightgray"},rolesListRow:{height:"60px"},rolesListRowText:{fontSize:"100px"},permissionsTable:{height:"100%",flexGrow:"1"},permissionsTableRowInherited:{color:"grey"},permissionsTableRow:{}})(L),v=()=>t(S).defaultClient;export{I as VistaCheck,S as VistaContext,C as VistaGrant,x as VistaProvider,T as VistaRoles,v as useVistaClient};
//# sourceMappingURL=index.js.map
