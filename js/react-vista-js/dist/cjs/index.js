"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("@vista.io/vista-api-client"),s=require("@mui/styles"),r=require("@mui/material/Button"),l=require("@mui/material/FormControl"),a=require("@mui/material/InputLabel"),n=require("@mui/material/Checkbox"),o=require("@mui/material/Box"),i=require("@mui/material/List"),c=require("@mui/material/ListItem"),d=require("@mui/material/ListItemText"),u=require("@mui/material/MenuItem"),p=require("@mui/material/Select"),h=require("@mui/material/Chip"),m=require("@mui/material/Autocomplete"),f=require("@mui/material/TextField"),g=require("@mui/material/ListItemButton"),y=require("react-data-table-component");function b(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var x=b(e),S=b(t),R=b(r),I=b(l),w=b(a),C=b(n),E=b(o),_=b(i),L=b(c),T=b(d),v=b(u),N=b(p),k=b(h),G=b(m),q=b(f),B=b(g),F=b(y);const P=x.default.createContext({secret:"",defaultClient:new S.default("","","")});class V extends x.default.Component{render(){const{secret:e,branch:t,hostname:s}=this.props,r=new S.default(e,t,s);return x.default.createElement(P.Provider,{value:{secret:this.props.secret,defaultClient:r}},this.props.children)}}class j extends x.default.Component{constructor(){super(...arguments),this.state={hasChecked:!1,granted:!1},this.componentDidMount=async()=>{if(!this.state.hasChecked){const e=this.context.defaultClient,t=(await e.users.check(this.props.userId,this.props.action,this.props.resourceId,this.props.resourceType,this.props.branch).catch((e=>{this.props.handleError?this.props.handleError(e):console.log(e)}))).length>0;t&&this.setState({hasChecked:!0,granted:t})}}}renderedComponent(){return this.state.hasChecked&&this.state.granted?this.props.children:this.props.denyComponent?this.props.denyComponent:null}render(){return x.default.createElement(x.default.Fragment,null,this.renderedComponent())}}j.contextType=P;function O(e){const{label:t,userRoles:s,grantSelectLabel:r,grantSelectLabelStyles:l,allRoles:a,selectClassName:n,chipsClassName:o,selectStyles:i,chipsStyles:c,grantRole:d,revokeRole:u}=e;return x.default.createElement(I.default,{sx:{minWidth:"200px"}},x.default.createElement(w.default,{className:r,style:l,shrink:s.length>0},t||""),x.default.createElement(N.default,{multiple:!0,value:[...s],renderValue:e=>x.default.createElement(E.default,{sx:{display:"flex",flexWrap:"wrap",gap:.5}},e.sort().map((e=>x.default.createElement(k.default,{key:e,label:e,className:o,style:c||{}})))),onChange:e=>{const t=e.target.value;if(t.length<s.length){const e=new Set(t),r=s.find((t=>!e.has(t)));r&&u(r)}else{const e=new Set(s),r=t.find((t=>!e.has(t)));r&&d(r)}},label:t||"",className:n,style:i||{}},a.map((e=>e.id)).sort().map((e=>x.default.createElement(v.default,{key:e,value:e},x.default.createElement(C.default,{checked:s.includes(e)}),x.default.createElement(T.default,{primary:e}))))))}class U extends x.default.Component{constructor(e,t){super(e),this.onGrantChange=async(e,t,s)=>{const{branch:r,orgId:l,onGrant:a}=this.props;if(!a)return;const n=await s(e,t,l,r);return n&&await this.refresh(l,r),n},this.state={client:t.defaultClient,userIdInput:"",selectedUserId:"",selectedRoleIds:[],roles:[],usersetIdToGrants:{},userIds:[],orgId:e.orgId,branch:e.branch}}async componentDidUpdate(){const{orgId:e,branch:t}=this.props;this.state.orgId===e&&this.state.branch===t||""!==e&&""!==t&&(await this.refresh(this.props.orgId,this.props.branch),this.setState({orgId:this.props.orgId,branch:this.props.branch}))}async refresh(e,t){const s=(await this.state.client.withBranch(t).users.list(e)).map((e=>e.id)),r=await this.state.client.withBranch(t).roles.list(e),l=await this.state.client.withBranch(t).grants.listUnflattened(null,null,null,null,null,null,e),a={};l.forEach((e=>{a[e.userset_id]||(a[e.userset_id]=[]),"ROLE"===e.relation_type&&a[e.userset_id].push(e)})),this.setState({userIds:s,roles:r,usersetIdToGrants:a})}render(){const{classes:e,styles:t,userIdMap:s,title:r,onGrant:l,onRevoke:a}=this.props,{selectedUserId:n,selectedRoleIds:o,roles:i,usersetIdToGrants:c,userIds:d,userIdInput:u}=this.state;return x.default.createElement("div",{className:e.container,style:t.container},x.default.createElement("h1",{className:e.title,style:t.title},r),x.default.createElement("div",{className:e.newGrantRow,style:t.newGrantRow},x.default.createElement("div",{className:e.userSelectContainer,style:t.userSelectContainer},x.default.createElement(G.default,{value:n,onChange:(e,t)=>{this.setState({selectedUserId:t||"",selectedRoleIds:[]})},inputValue:u,onInputChange:(e,t)=>{this.setState({userIdInput:t})},className:e.userSelect,style:t.userSelect,sx:{width:"100% "},options:s?["*",...Object.keys(s)]:["*",...d],renderInput:s=>x.default.createElement(q.default,Object.assign({},s,{InputLabelProps:{className:e.grantSelectLabel,style:t.grantSelectLabel},label:"Select User"}))})),x.default.createElement("div",{className:e.roleSelect,style:t.roleSelect},x.default.createElement(O,{label:"Select Role",userRoles:o,grantRole:e=>{o.push(e),this.setState({selectedRoleIds:o})},revokeRole:e=>{this.setState({selectedRoleIds:o.filter((t=>t!==e))})},selectClassName:e.grantRoleSelect,chipsClassName:e.grantRoleSelectChip,selectStyles:t.grantRoleSelect,chipsStyles:t.grantRoleSelectChip,grantSelectLabel:e.grantSelectLabel,grantSelectLabelStyles:t.grantSelectLabel,allRoles:n.length&&c[n]?i.filter((e=>!c[n].map((e=>e.relation)).includes(e.id))):i})),x.default.createElement(R.default,{className:e.grantButton,style:t.grantButton,variant:"contained",disabled:!(n.length&&o.length),onClick:async()=>{for(const e of o)await this.onGrantChange(n,e,l);this.setState({selectedUserId:"",selectedRoleIds:[]})}},"Grant")),x.default.createElement("div",{className:e.grantList,style:t.grantList},x.default.createElement(_.default,null,Object.keys(c).sort().map((s=>{const r=c[s],n=r.map((e=>e.relation));return x.default.createElement(L.default,{key:s,className:e.grantRow,style:t.grantRow,secondaryAction:x.default.createElement(O,{userRoles:n,grantRole:e=>{r.push({userId:s,relation:e,userset_id:s,relation_type:"ROLE"}),c[s]=r,this.onGrantChange(s,e,l),this.setState({usersetIdToGrants:c})},revokeRole:e=>{const t=r.filter((t=>t.relation!==e));c[s]=t,this.onGrantChange(s,e,a),this.setState({usersetIdToGrants:c})},selectClassName:e.grantRoleSelect,chipsClassName:e.grantRoleSelectChip,selectStyles:t.grantRoleSelect,chipsStyles:t.grantRoleSelectChip,grantSelectLabel:e.grantSelectLabel,grantSelectLabelStyles:t.grantSelectLabel,allRoles:i})},x.default.createElement(T.default,{primary:s}))})))))}}U.contextType=P,U.defaultProps={styles:{},title:"Add Teammates"};const A=s.withStyles({container:{height:"500px",width:"600px",display:"flex",flexDirection:"column",border:"solid",borderColor:"lightgray",borderWidth:"1px",padding:"50px",marginBottom:"50px"},title:{marginTop:"0px"},newGrantRow:{display:"flex",marginBottom:"20px"},userSelectContainer:{flexGrow:"1",height:"64px !important",marginRight:"10px"},userSelect:{height:"64px !important","& \t.MuiAutocomplete-inputRoot":{height:"64px"}},grantSelectLabel:{top:"4px"},roleSelect:{marginRight:"10px"},grantButton:{},grantRow:{height:"75px"},grantList:{flexGrow:"1",width:"100%",padding:"0",border:"solid",borderColor:"lightgray",borderWidth:"1px",overflow:"scroll",margin:"0"},grantRoleSelect:{height:"64px"},grantRoleSelectChip:{backgroundColor:"black !important",color:"white !important"}})(U);function M(e){const{row:t,classes:s,text:r}=e,l=e.styles||s;return x.default.createElement("p",{className:t.inheritedFrom?s.permissionsTableRowInherited:s.permissionsTableRow,style:t.inheritedFrom?l.permissionsTableRowInherited:l.permissionsTableRow}," ",r," ")}function W(e){const{classes:t,styles:s,title:r}=e;return x.default.createElement("div",{className:t.permissionsTable},x.default.createElement(F.default,{title:r,columns:[{name:"Resource Type",selector:()=>"resourceType",sortable:!0,cell:e=>x.default.createElement(M,{text:e.resourceType,classes:t,styles:s,row:e})},{name:"Attribute",selector:()=>"attribute",sortable:!0,right:!0,cell:e=>x.default.createElement(M,{text:e.attribute,classes:t,styles:s,row:e})},{name:"Actions",selector:()=>"actions",sortable:!0,right:!0,cell:e=>x.default.createElement(M,{text:e.actions.join(", "),classes:t,styles:s,row:e})},{name:"Inherited From",selector:()=>"inheritedFrom",sortable:!0,right:!0,cell:e=>x.default.createElement(M,{text:e.inheritedFrom,classes:t,styles:s,row:e})}],data:(()=>{const{rolesById:t,role:s}=e;if(!s)return[];const r={},l=[...s.parent_roles],a=new Set,n=[];for(;l.length;){const e=l.shift();if(!e||a.has(e))continue;a.add(e);const s=t[e];for(const e in s.resource_types_to_attributes_to_actions)for(const t in s.resource_types_to_attributes_to_actions[e]){const l=s.resource_types_to_attributes_to_actions[e][t],a=`${e}_${t}`;r[a]||(n.push({actions:l,attribute:t,id:a,resourceType:e,inheritedFrom:s.id}),r[a]=!0)}l.push(...s.parent_roles)}for(const e in s.resource_types_to_attributes_to_actions)for(const t in s.resource_types_to_attributes_to_actions[e]){const l=`${e}_${t}`,a=s.resource_types_to_attributes_to_actions[e][t];r[l]||(n.push({id:l,actions:a,attribute:t,resourceType:e,inheritedFrom:""}),r[l]=!0)}return n})()}))}class $ extends x.default.Component{constructor(e,t){super(e),this.state={client:t.defaultClient,rolesById:{},selectedRoleId:""}}async componentDidMount(){const e=await this.state.client.roles.list(this.props.orgId),t={};e.forEach((e=>{t[e.id]=e}));const s=e.length?e[0].id:"";this.setState({rolesById:t,selectedRoleId:s})}render(){const{classes:e}=this.props,t=this.props.styles||e,{rolesById:s,selectedRoleId:r}=this.state;return x.default.createElement("div",{className:e.container,style:t.container},x.default.createElement(_.default,{className:e.rolesList,style:t.rolesList,disablePadding:!0},Object.values(s).map((s=>x.default.createElement(L.default,{key:s.id,disablePadding:!0},x.default.createElement(B.default,{className:e.rolesListRow,style:t.rolesListRow,selected:r===s.id,disableRipple:!0,onClick:()=>this.setState({selectedRoleId:s.id})},x.default.createElement(T.default,{primary:s.id})))))),x.default.createElement(W,{title:`${r} Permissions`,rolesById:s,role:s[r],classes:e,styles:t}))}}$.contextType=P,$.defaultProps={styles:{}};const D=s.withStyles({container:{height:"500px",width:"1000px",display:"flex",border:"solid",borderColor:"lightgray",borderWidth:"1px"},title:{marginTop:"0px"},rolesList:{height:"100%",width:"200px",overflow:"scroll",borderRight:"1px solid lightgray"},rolesListRow:{height:"60px"},rolesListRowText:{fontSize:"100px"},permissionsTable:{height:"100%",flexGrow:"1"},permissionsTableRowInherited:{color:"grey"},permissionsTableRow:{}})($);Object.defineProperty(exports,"VistaClient",{enumerable:!0,get:function(){return S.default}}),exports.VistaCheck=j,exports.VistaContext=P,exports.VistaGrant=A,exports.VistaProvider=V,exports.VistaRoles=D,exports.useVistaClient=()=>e.useContext(P).defaultClient;
//# sourceMappingURL=index.js.map
